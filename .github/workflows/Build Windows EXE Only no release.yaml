name: "Build Windows (EXE Only)"

on:
  push:
    branches:
      - dev
  workflow_dispatch:

jobs:
  build_windows:
    runs-on: windows-2022
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Inno Setup
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (Test-Path .\installer\install_inno_setup.ps1) {
            Write-Host "Running local installer script..."
            .\installer\install_inno_setup.ps1
          } else {
            Write-Host "Local installer script not found, skipping."
          }
          if (-not (Get-Command iscc -ErrorAction SilentlyContinue)) {
            if (Get-Command winget -ErrorAction SilentlyContinue) {
              Write-Host "Installing Inno Setup via winget..."
              winget install -e --id JRSoftware.InnoSetup --silent --accept-package-agreements --accept-source-agreements
            } else {
              Write-Host "winget not found, installing via Chocolatey..."
              choco install innosetup -y --no-progress
            }
          }
          $iscc = (Get-ChildItem "C:\Program Files*\Inno Setup*\ISCC.exe" -Recurse -ErrorAction SilentlyContinue |
                   Select-Object -First 1 -ExpandProperty FullName)
          if (-not $iscc) { throw "ISCC.exe not found after installation" }
          "ISCC=$iscc" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "ISCC resolved to: $iscc"

      - name: Build Flutter Windows app
        run: flutter build windows --release

      - name: Build Inno Setup installer
        run: |
          & "$env:ISCC" installer\otzaria.iss
        shell: pwsh

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: otzaria-windows-installer
          path: installer/otzaria-*-windows*.exe
