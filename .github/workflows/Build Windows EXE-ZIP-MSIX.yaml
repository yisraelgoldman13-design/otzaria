name: "Build Windows (EXE, ZIP, MSIX)"

on:
  workflow_dispatch:

jobs:
  build_windows:
    runs-on: windows-2022
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true

      - name: Install Inno Setup
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          if (Test-Path .\installer\install_inno_setup.ps1) {
            Write-Host "Running local installer script..."
            .\installer\install_inno_setup.ps1
          } else {
            Write-Host "Local installer script not found, skipping."
          }
          if (-not (Get-Command iscc -ErrorAction SilentlyContinue)) {
            if (Get-Command winget -ErrorAction SilentlyContinue) {
              Write-Host "Installing Inno Setup via winget..."
              winget install -e --id JRSoftware.InnoSetup --silent --accept-package-agreements --accept-source-agreements
            } else {
              Write-Host "winget not found, installing via Chocolatey..."
              choco install innosetup -y --no-progress
            }
          }
          $iscc = (Get-ChildItem "C:\Program Files*\Inno Setup*\ISCC.exe" -Recurse -ErrorAction SilentlyContinue |
                   Select-Object -First 1 -ExpandProperty FullName)
          if (-not $iscc) { throw "ISCC.exe not found after installation" }
          "ISCC=$iscc" | Out-File -FilePath $env:GITHUB_ENV -Append
          Write-Host "ISCC resolved to: $iscc"

      - name: Build Flutter Windows app
        run: flutter build windows --release

      - name: Zip Windows build
        shell: pwsh
        run: |
          $relDir = Get-ChildItem -Directory build\windows |
                    Where-Object { Test-Path "$($_.FullName)\runner\Release" } |
                    Select-Object -First 1 -ExpandProperty FullName
          if (-not $relDir) { throw 'Release directory not found' }
          Compress-Archive -Path "$relDir\runner\Release\*" -DestinationPath otzaria-windows.zip

      - name: Build MSIX package
        run: dart run msix:create --install-certificate false

      - name: Build Inno Setup installer
        run: |
          & "$env:ISCC" installer\otzaria.iss
        shell: pwsh

      - name: Upload Windows installer
        uses: actions/upload-artifact@v4
        with:
          name: otzaria-windows-installer
          path: installer/otzaria-*-windows*.exe

      - name: Upload Windows ZIP
        uses: actions/upload-artifact@v4
        with:
          name: otzaria-windows-zip
          path: otzaria-windows.zip

      - name: Upload Windows MSIX
        uses: actions/upload-artifact@v4
        with:
          name: otzaria.msix
          path: build/windows/x64/runner/release/*.msix

  create_release:
    needs: [build_windows]
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Get version from pubspec.yaml
        id: version
        run: |
          VERSION=$(grep '^version:' pubspec.yaml | cut -d ' ' -f 2 | cut -d '+' -f 1)
          BRANCH_NAME="${{ github.ref_name }}"
          CLEAN_BRANCH=$(echo "$BRANCH_NAME" | sed 's/[^A-Za-z0-9.-]/-/g')
          echo "tag=$VERSION+${CLEAN_BRANCH}.${{ github.run_number }}" >> $GITHUB_OUTPUT
          echo "prerelease=true" >> $GITHUB_OUTPUT
          echo "title=Otzaria $VERSION (Preview from ${{ github.ref_name }})" >> $GITHUB_OUTPUT

      - name: Get commit message
        id: commit
        run: echo "message=$(git log -1 --pretty=%s)" >> $GITHUB_OUTPUT

      - name: Organize release files
        run: |
          mkdir -p release-files
          
          if [ -d "artifacts/otzaria-windows-installer" ]; then
            cp artifacts/otzaria-windows-installer/*.exe release-files/
          fi
          
          if [ -d "artifacts/otzaria-windows-zip" ]; then
            cp artifacts/otzaria-windows-zip/*.zip release-files/
          fi

          if [ -d "artifacts/otzaria.msix" ]; then
            cp artifacts/otzaria.msix/*.msix release-files/
          fi
          
          echo "Release files:"
          ls -la release-files/
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.title }}
          prerelease: ${{ steps.version.outputs.prerelease }}
          files: release-files/*
          body: |
            ## Windows Test Build
            Built from commit: `${{ github.sha }}` - *${{ steps.commit.outputs.message }}*
            Branch: `${{ github.ref_name }}`
